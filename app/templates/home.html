{% load static %}
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
{#    <link rel="stylesheet" href="{%static 'css/message.css'%}">#}

    <title>chat online</title>

</head>
<style>
    body{
    height: 100%;
    margin:0
}
.col_menu{
    width: 70px;
    float: left;
    height: 100%
}
.col_menu > a >img{
    float: left;
    width: 50px;
    height: 50px;
    padding: 10px;
    margin: 10% 17%;
}
.col_menu > a > img:hover{
    cursor: pointer;
    background-color: lightgray;
    border-radius: 10px;
    transform: scale(1.1);
    transition: 0.3s;
}
.hienthi .col_left{
    width: 375px;
    border-left:rgb(191, 190, 190) solid 1px;
    border-right: rgb(191, 190, 190) solid 1px;
    float: left;
    height: 720px;
    position: relative;
    overflow-y:scroll ;
}
.hienthi .col_left > .mess {
    margin: 30px 20px;
    float:left;
    font-size: 20px;
    font-weight: bold;
    font-family:'Segoe UI', Tahoma,Verdana, sans-serif;
}
.hienthi .col_left > img {
    width: 30px;
    height: 30px;
    margin:30px 25px 15px 0;
    float:right;
    cursor: pointer;
}
.mess1{
    width: 100%;
    height: 80px;
    float: left;
    color: black;
    transition: 0.2s;
}
.mess1:hover{
    background-color: rgb(247, 247, 247);
}
.mess1.active {
    background-color: rgb(229, 228, 228)
}
.ava{
    background-size: cover;
    border-radius: 50%;
    padding:30px;
    margin: 10px 0 0 10px;
    float: left;
    cursor: pointer;
}
.username{
    float: left;
    font-size: 14px;
    margin: 18px 0 0 10px;
    font-family:'Segoe UI', Tahoma,Verdana, sans-serif;
    cursor: pointer;
    font-weight: 500;
}
.mini_content{
    float: left;
    font-size: 12px;
    margin: -5px 0 0 10px;
    font-family:'Segoe UI', Tahoma,Verdana, sans-serif;
    color: gray;
    max-width: 250px;
    white-space: nowrap;
    overflow:hidden
}
.col_right{
    position: absolute;
    right:0;
    left:445px
}
.col_right > .ten{
    height: 80px;
    border-bottom: lightgray solid 1px;
}
.col_right > .ten > div > .nghe_goi{
    padding: 15.25px;
    position: absolute;
    margin-top: 10px;
    cursor: pointer;
    background-size: cover;
}
#more_info{
    right:0;
    background-image: url('https://img.icons8.com/?size=256&id=24865&format=png');
}
#more_info:hover{
    background-image: url('https://img.icons8.com/?size=256&id=102729&format=png');
}
.col_right > .content{
    height: 590px;
    overflow-y:scroll ;
}
.col_right > .chat_box{
    position: relative;
    padding: 10px
}
.col_right > .chat_box > form > textarea{
    height: 45px;
    line-height: 2.5;
    border: lightgray solid 1px;
    border-radius: 30px;
    padding-left: 55px;
    padding-right: 130px;
    max-height: 100px;
    overflow: hidden;
    overflow-wrap: break-word;
    font-size: 17px;
    font-family:'Segoe UI', Tahoma, Verdana, sans-serif;
    position: absolute;
    right: 60px;
    left: 20px;
    resize: none;
    outline:none
}
.col_right > .chat_box > form > .icon{
    width: 50px;
    height: 50px;
    position: absolute;
    top:8px;
    padding: 10px;
    cursor: pointer;
}
#smile_icon{
    left: 27px;
}
#microphone_icon{
    right:120px;
}
#attachment_icon{
    right: 72px;
    width: 50px;
    height: 50px;
    position: absolute;
    top:8px;
    padding: 10px;
    cursor: pointer;
}
#button_heart{
    right: 10px;
}
#button_heart:hover{
    scale: 1.1;
    transition: 0.3s;
}
.col_right >.chat_box >form > div > label > .nho{
    width:40px;
    height:40px;
    margin:5px
}
.col_right >.chat_box >form > #myIcon{
    width:300px;
    height:200px;
    box-shadow:1px 2px 5px lightgray;
    display: none;
    position:absolute;
    bottom:30px;
    left:50px;
    border-radius:10px;
    overflow: auto;
    padding: 15px 5px;
}
/* Container để giữ input và icon nằm chung */
.timkiem-container {
    display: flex;
    align-items: center;
    position: relative;
}

/* Tạo độ rộng cho input */
.tim_kiem {
    width: 100%;
    padding: 10px;
    padding-right: 30px; /* Giữ khoảng cách cho icon */
    border: 1px solid #ccc;
    border-radius: 4px;
}

/* Đặt icon vào trong cùng một hàng với input */
.
-icon-btn {
    position: absolute;
    right: 10px; /* Đặt icon về phía bên phải */
    border: none;
    background: none;
    cursor: pointer;
}

.search-icon {
    width: 20px; /* Điều chỉnh kích thước của icon */
}
/* Container để giữ input và icon nằm chung */
.timkiem-container {
    display: flex;
    align-items: center;
    position: relative;
}

/* Tạo độ rộng cho input */
.tim_kiem {
    width: 100%;
    padding: 10px;
    padding-right: 30px; /* Giữ khoảng cách cho icon */
    border: 1px solid #ccc;
    border-radius: 10px;
}

/* Đặt icon vào trong cùng một hàng với input */
.search-icon-btn {
    position: absolute;
    right: 10px; /* Đặt icon về phía bên phải */
    border: none;
    background: none;
    cursor: pointer;
}

.search-icon {
    width: 20px; /* Điều chỉnh kích thước của icon */
}

@media (max-width:900px){
    .hienthi .col_left{
        width: 100px;
    }
    .hienthi .col_left > .mess{
        display: none;
    }
    .hienthi .col_left > img{
        right: 25px;
    }
    .hienthi .col_left > a >div>.username, .mini_content{
        display: none;
    }
    .col_right{
        left: 172px;
    }
}
@media(max-width:800px){
    .col_menu{
        display: none;
    }
    .hienthi .col_left{
        height: 670px;
    }
    .col_right{
        top:0;
        left:100px;
    }
    .col_right >.content{
        height:525px;
    }
    .col_right > .ten >.ava{
        margin-top: 15px;
        padding:25px
    }
    .hienthi .col_left > .mess1 >.ava{
        padding:25px;
        margin: 15px;
    }
    .username{
        margin: 30px 0 0 15px;
        font-size: 17px;
    }
}
#info{
    display:none;
    width:20%;
    position:absolute;
    right:0;
    border-left:  1px solid lightgray;
}
.layout_info{
    min-width:200px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    padding:20px;
    font-size: 25px;
    border-bottom: 1px solid lightgray;
}
.info_2{
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: 16px;
    padding:22px;
    color: #ED4956;
    cursor: pointer;
    float: left;
    width: 100%;
}
.content-message{
    width:100%;
    float:left;
    position: relative;
}
.image-message{
    width:350px;
    margin:2px 2% 2px 50px;
    float:right;
    border-radius: 20px 20px 2px 20px;
}
.text-message{
    max-width:60%;
    overflow-wrap:break-word;
    padding:10px;
    background: lightgray;
    margin:2px 2%;
    font-size:16.5px
}
.sent-message{
    border-radius:18px 18px 2px 18px;
    float:right;
}
.received-message{
    float:left;
    border-radius:18px 18px 18px 2px;
    margin-bottom: 15px;
}
.link-message a {
    max-width:60%;
    overflow-wrap:break-word;
    padding:10px;
    background: lightgray;
    margin:2px 2% 2px 50px;
    font-size:16.5px;
    color: blue;
    text-decoration: underline;
}
.message_time{
    float:right;
    color:gray;
    margin-top:15px;
    font-size:12px
}
#myIcon > button{
    width:50px;
    background: none;
    font-size: 28px;
    border:none
}
.layout_url{
    width:310px; float:right; background:lightgray;border-radius:20px 20px 2px 20px;margin: 10px 2% 10px 50px
}
.avt_url{
    width:32px;
    height:32px;
    border-radius: 50%;
    background-size: cover;
    background-position: center;
    float: left;
    margin:10px;
}
.user_url{
    font-size:15px; margin:17px 7px 15px 0;color:black;font-weight:500;float:left
}
.content_url{
    float:left;margin:20px 7px;font-size:12px;color:black
}
.layout_tim_kiem{
    width:60%;
    float: right;
    margin-top: 30px;
    position: relative;
    display: flex;
}
.layout_tim_kiem > form {
    position: relative;
}
.layout_tim_kiem >form > input{
    width:100%;
    height: 40px;
    outline: none;
    padding-left: 15px;
    border-radius: 20px;
    background-color: #EEEEEE;
    border: none;
}
.layout_tim_kiem > form > img {
    top: 12px;
    height: 1vw;
    position: absolute;
    right: 13px;
}

.layout_tim_kiem > a >  button {
    padding: 8px 12px;
    border: 1px solid #fff;
    border-radius: 5px;
    background-color: #fff;
    cursor: pointer;
    transition: background-color 0.3s;
    height: 40px;
    margin-left: 8px;
    margin-right: 15px;
}

.layout_tim_kiem > a > button:hover {
    background-color: #f0f0f0;
}

.mess1 .ava {
    width: 40px;
    height: 40px;
    background-color: gray;
    background-position: center;
    border-radius: 50%;
    margin-right: 10px;
}

.mess1 .username {
    font-weight: bold;
}

.button-group {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
}

.add-user-btn {
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 10px 20px;
    cursor: pointer;
}

.add-user-btn:hover {
    background-color: #0056b3; /* Màu xanh đậm hơn khi hover */
}

.user-list {
    padding: 10px;
}

.user-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px;
    border-bottom: 1px solid lightgray;
}

.user-item .ava {
    width: 40px;
    height: 40px;
    background-color: gray;
    border-radius: 50%;
    margin-right: 10px;
}

.user-item .username {
    flex-grow: 1;
}

.add-checkbox {
    margin-left: auto;
}
</style>
<body>
    <div class="col_menu">
        <a href="/blockedlist/"><img style="margin-top: 100px;" width="24" height="24" src="https://img.icons8.com/external-tanah-basah-basic-outline-tanah-basah/24/external-block-user-user-tanah-basah-basic-outline-tanah-basah.png" alt="external-block-user-user-tanah-basah-basic-outline-tanah-basah"/></a>
        <a><img src="https://img.icons8.com/?size=256&id=dJOh7yntdHD9&format=png"></a>
        <a href="/myprofile/"><img width="50" height="50" src="https://img.icons8.com/fluency-systems-regular/50/user--v1.png" alt="user--v1"/></a>
        <a style="text-decoration:none;float:left" data-toggle="modal" href='#logout-modal'><img width="32" height="32" src="https://img.icons8.com/windows/32/exit.png" alt="exit"/></a>
        <a href="change-password/"><img width="50" height="50" src="https://img.icons8.com/?size=100&id=64777&format=png&color=000000" alt="user--v1"/></a>
<div class="modal fade" id="logout-modal">
    <div class="modal-dialog">
        <div class="modal-content" style="border-radius:20px;margin:32vh auto;width:50vh">
            <div class="modal-header">
                <h5 class="modal-title" style="padding:5px 0 5px 30px">Bạn muốn đăng xuất?</h5>
            </div>
            <div class="modal-body" style="padding:0">
                <form action="{% url 'logout' %}" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <button type="submit" class="info_2" style="text-align:center;border:none;background:none;border-bottom:1px solid #EEE;padding:15px 20px">Đăng xuất</button>
                </form>
                <div class="info_2" data-dismiss="modal" style="text-align:center;color:black;padding:20px">Hủy</div>
            </div>
        </div>
    </div>
</div>
    </div>
    <div class="hienthi">
        <div class="col_left">
            <div class="mess">Messages</div>
  <div class="layout_tim_kiem">
    <form id="timkiem_form">
        <div class="timkiem-container">
            <input
                class="tim_kiem"
                type="text"
                id="searchInput"
                placeholder="Tìm kiếm người dùng hoặc nhóm chat..."
                oninput="performLiveSearch(this.value)"
            />
            <button type="button" class="search-icon-btn">
                <img src="https://img.icons8.com/search" alt="search icon" class="search-icon">
            </button>
        </div>
    </form>
    <a data-toggle="modal" href="#creatGroupChat" class="theAOpenModal" title="Tạo nhóm chat">
        <button><i class="fa-solid fa-user-plus"></i></button>
    </a>
</div>

<div  id="chatUsersListContainer">
    <!-- Kết quả tìm kiếm sẽ được thêm vào đây -->
</div>


            <div class="modal fade" id="creatGroupChat">
                <div class="modal-dialog">
                    <form action="" enctype="multipart/form-data" method="post">
                        <div class="modal-content" style="width:480px;height:520px; border-radius:15px;margin-top:10vh">
                            <div class="modal-header" style="border-bottom: 1px solid #DBDBDB;height:50px">
                                <h5 class="modal-title" style="position:absolute;left:32%;text-align:center;">Tạo nhóm chat</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true" style="border:none;padding:30px;background:none;position:absolute;right:0">&times;</button>
                            </div>
                            <div class="modal-body" style="padding:0">
                                <!-- Group's image -->
                                <input type="file" name="file" id="fileInput" accept="image/*" style="display: none;">
                                <label for="fileInput" style="cursor: pointer; margin-left: 30px; margin-top:15px; float:left ">
                                    <i class="fa-solid fa-camera" style="scale:2"></i>
                                </label>
                                <!-- Group's name -->
                                <input id="groupName" placeholder="Nhập tên nhóm"
                                           style="width:82%;height: 40px;outline: none;border: none;border-bottom: 1px solid #DBDBDB; margin-right: 10px; float: right">
                                <!-- Search -->
                                <form enctype="multipart/form-data" method="post">
                                    <i style="top:65px;position: absolute;left:25px" class="fa-solid fa-magnifying-glass"></i>
                                    <input id="searchUser" placeholder="Nhập tên hoặc email"
                                           style="width: 95%;outline: none;padding: 10px 10px 10px 45px; border: 1px solid #ccc; border-radius: 15px; margin: 10px;">
                                </form>

                                <!-- Show users -->
                                <div class="showUsers" style="height: 270px; overflow:auto"></div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary btnCreateRoom">Tạo nhóm</button>
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="chat_users_list"></div>
        </div>
    </div>
    <div class="col_right">
        <div class="ten">
            <div id="userInfo"></div>
            <div style="position: absolute; right:20px; top:17px">
                <div class="nghe_goi" id="more_info" onclick="myFunction()"></div>
            </div>
        </div>
        <div class="content"></div>
        <div class="chat_box">
            <form id="messageForm" style="display: block" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <textarea type="text" name="content" placeholder="Message..."></textarea>
                <img class="icon" id="smile_icon" onclick="showIcon()" src="https://img.icons8.com/?size=512&id=y6j3NCqRGOcj&format=png">
                    <div id="myIcon">
                        <button type="button" class="icon_cuoi">😀</button>
                        <button type="button" class="icon_cuoi">&#128513;</button>
                        <button type="button" class="icon_cuoi">&#128514;</button>
                        <button type="button" class="icon_cuoi">&#129392;</button>
                        <button type="button" class="icon_cuoi">&#129325;</button>
                        <button type="button" class="icon_cuoi">&#128517;</button>
                        <button type="button" class="icon_cuoi">&#128518;</button>
                        <button type="button" class="icon_cuoi">&#128519;</button>
                        <button type="button" class="icon_cuoi">&#128520;</button>
                        <button type="button" class="icon_cuoi">&#128521;</button>
                        <button type="button" class="icon_cuoi">&#128522;</button>
                        <button type="button" class="icon_cuoi">&#128523;</button>
                        <button type="button" class="icon_cuoi">&#128524;</button>
                        <button type="button" class="icon_cuoi">&#128525;</button>
                        <button type="button" class="icon_cuoi">&#128526;</button>
                        <button type="button" class="icon_cuoi">&#128527;</button>
                        <button type="button" class="icon_cuoi">&#128528;</button>
                        <button type="button" class="icon_cuoi">&#128529;</button>
                        <button type="button" class="icon_cuoi">&#128530;</button>
                        <button type="button" class="icon_cuoi">&#128531;</button>
                        <button type="button" class="icon_cuoi">&#128532;</button>
                        <button type="button" class="icon_cuoi">&#128533;</button>
                        <button type="button" class="icon_cuoi">&#129297;</button>
                        <button type="button" class="icon_cuoi">&#129322;</button>
                        <button type="button" class="icon_cuoi">&#129398;</button>
                    </div>
                <input type="file" name="file" id="image" accept="image/*, video/*" style="display: none;">
                <label for="image">
                    <img class="icon" id="attachment_icon" src="https://img.icons8.com/?size=512&id=114320&format=png">
                </label>

                <i style="scale:1.5; margin-top: 5px;width:40px; height:40px" class="icon fa-solid fa-heart" id="button_heart"></i>
            </form>
            <div class="blocked_layout" style="display: none; text-align: center;color: gray;">Bạn đã bị chặn bởi người dùng này.</div>
        </div>
    </div>

    <div id=info>
        <div class="layout_info"><div class="info_1">Chi tiết</div></div>
        <div style="height:520px;border-bottom: 1px solid lightgray;">

            <!-- js fetchInfo thông tin user or room -->
            <div class= "layout_info1"></div>

            <!-- modal add user -->
            <a data-toggle="modal" id="btnAddUser" href='#addUserModal' style="display:none;color:black" class="theAOpenModalAddUser">
                <button class="mess1" style="border: none;width: 80%;height: 50px;margin: 10%;border-radius: 8px;">
                    Thêm người dùng <i class="fa-solid fa-user-plus"></i></button>
            </a>
            <div class="modal fade" id="addUserModal">
                <div class="modal-dialog">
                    <form id="addMembersForm" method="post">
                        <div class="modal-content" style="width:480px;height:420px; border-radius:15px;margin-top:20vh">
                            <div class="modal-header" style="border-bottom: 1px solid #DBDBDB;height:50px">
                                <h5 class="modal-title" style="position:absolute;left:32%;text-align:center;">Thêm người dùng</h5>
                                <button type="button" class="close" data-dismiss="modal" style="border:none;padding:30px;background:none;position:absolute;right:0">&times;</button>
                            </div>
                            <div class="modal-body" style="padding:0;overflow:auto">
                                <!-- Search -->
                                <form enctype="multipart/form-data" method="post">
                                    <i style="top:12px;position: absolute;left:13px" class="fa-solid fa-magnifying-glass"></i>
                                    <input id="searchUser" placeholder="Nhập tên hoặc email"
                                           style="width:100%;height: 40px;outline: none;padding-left: 45px;border: none;border-bottom: 1px solid #DBDBDB;">
                                </form>

                                <!-- Show users -->
                                <div class="showUsersNotInRoomId">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-primary ">Thêm người dùng</button>
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="title_members" style="display: none">Thành viên nhóm</div>
            <div class="memberList" style="overflow-y: auto;height: 330px;"></div>
        </div>


        <div class = "layout_info2"></div>
    </div>
</body>

<script>
    let currentUserId = {{ request.session.current_user_id }};
    // Hàm để ẩn/hiện khung thông tin
    function myFunction() {
        var colRight = document.querySelector(".col_right");
        var info = document.getElementById("info");

        if (colRight.style.right === "20%") {
            colRight.style.right = "0";
            info.style.display = "none";
        } else {
            colRight.style.right = "20%";
            info.style.display = "block";
        }
    }

    // Hiển thị icon cảm xúc
    function showIcon() {
        document.getElementById("myIcon").style.display = "block";
    }

    $('textarea[name="content"]').keyup(function () {
        if ($(this).val() !== "") {
            $("#button_heart").removeClass("fa-heart").addClass("fa-paper-plane");
        } else {
            $("#button_heart").removeClass("fa-paper-plane").addClass("fa-heart");
        }
    });

    // Xử lý khi người dùng nhấn phím Enter để gửi tin nhắn
    $('textarea[name="content"]').keydown(function (e) {
        if (e.keyCode == 13 && !e.shiftKey && $(this).val().trim() !== "") {
            e.preventDefault();
            $("#messageForm").submit();
        }
    });

    $("#button_heart").click(function () {
        if ($("#button_heart").hasClass("fa-paper-plane")) {
            // Nếu là icon gửi, thì gửi form
            $("#messageForm").submit();
            $("#button_heart").removeClass("fa-paper-plane").addClass("fa-heart");
        } else if ($("#button_heart").hasClass("fa-heart")) {
            $('textarea[name="content"]').val('❤️');
            $("#messageForm").submit();
        }
    });


    // Thêm icon cảm xúc vào tin nhắn
    $(".icon_cuoi").click(function () {
        var icon = $(this).text();
        var current = $('textarea[name="content"]').val();
        $('textarea[name="content"]').val(current + icon);
    });


    // Ẩn icon cảm xúc khi click ra ngoài
    document.addEventListener('click', function (event) {
        var isClickInside = document.getElementById("smile_icon").contains(event.target);
        if (!isClickInside) {
            document.getElementById("myIcon").style.display = "none";
        }
    });
</script>



<script>
    let latestMessages = [];  // Mảng lưu trữ thông tin tin nhắn gần nhất
    // Sự kiện khi nhấn nút "Tạo nhóm"
$('.btnCreateRoom').on('click', function() {
    const groupName = $('#groupName').val();
    const avatarFileInput = document.getElementById('fileInput');
    const selectedUserIds = $('input[name="addUserId"]:checked').map(function() {
        return $(this).val();
    }).get();

    // Kiểm tra nếu không có tên nhóm
    if (!groupName.trim()) {
        alert("Vui lòng nhập tên nhóm.");
        return;
    }
    if (selectedUserIds.length === 0) {
        alert('Vui lòng chọn ít nhất một người dùng để tạo nhóm.');
        return;
    }

    // Xử lý hình ảnh đại diện (nếu có) hoặc đặt ảnh mặc định
    let avatarUrl = 'https://res.cloudinary.com/dpuldllty/image/upload/v1719823233/samples/balloons.jpg';
    if (avatarFileInput.files && avatarFileInput.files[0]) {
        avatarUrl = URL.createObjectURL(avatarFileInput.files[0]);
    }

    // Tạo payload gửi lên server
    fetchInfo(currentUserId, null, function () {
        const userData = userInfo[currentUserId];
        const payload = {
            'name': groupName,
            'avatar': avatarUrl,
            'creator': currentUserId,
            'users': selectedUserIds,
            'content': `Phòng được tạo bởi ${userData.username}`,
        };

        // Gửi yêu cầu tạo nhóm qua API
        $.ajax({
            url: 'api/chatrooms/create-room/',
            type: 'POST',
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            data: JSON.stringify(payload),
            success: function(data) {
                console.log('Nhóm chat đã được tạo:', data);
                latestMessages = [];
                fetchChatUsers();
                fetchChatRooms();

                $('#creatGroupChat').modal('hide');
            },
            error: function(error) {
                console.error("Lỗi khi tạo nhóm:", error);
            }
        });
    });
});

function fetchAllUsers(callback) {
    let htmlUserCreateRoom = '';
    $.ajax({
        url: '/api/users/',
        method: 'GET',
        success: function (data) {
             $.each(data, function (index, user) {
                 if (user.id === Number(currentUserId)) {
                     return;
                 }
                 if (callback) {
                    callback(data);
                }else {
                     htmlUserCreateRoom = `
                        <label for="mess${user.id}" class="mess1">
                            <div class="ava" style="background-image: url('${user.avatar}')"></div>
                            <div class="username">${user.username}</div><br><br>
                            <div class="mini_content">${user.email}</div>
                            <input type="checkbox" name="addUserId" value="${user.id}" id="mess${user.id}" style="float:right;margin:-20px 20px">
                        </label>`;

                     $('.showUsers').append(htmlUserCreateRoom);
                 }
            });
        },
        error: function (error) {
            console.error('Error fetching all users:', error);
        }
    });
}

function fetchChatUsers() {
    $.ajax({
        url: '/api/users/chat-users/',
        method: 'GET',
        success: function(users) {
            if (users.length > 0) {
                $.each(users, function (index, user) {
                    // Gọi hàm lấy tin nhắn gần nhất cho từng user
                    fetchLatestMessage(user.id, null, function(latestMessage) {
                        latestMessages.push({
                            id: user.id,
                            username: user.username,
                            email: user.email,
                            avatar: user.avatar,
                            type: 'user',
                            latestMessage: latestMessage
                        });
                        // Cập nhật giao diện sau khi có tất cả thông tin
                        updateChatListDisplay();
                    });
                });
                joinAllChannels(users, null);
            }
        },
        error: function(error) {
            console.error('Error fetching chat users:', error);
        }
    });
}

function fetchChatRooms() {
    $.ajax({
        url: `/api/userchatrooms/chat-rooms/?user_id=${currentUserId}`,
        method: 'GET',
        success: function (rooms) {
            if (rooms.length > 0) {
                $.each(rooms, function (index, room) {
                    // Gọi hàm lấy tin nhắn gần nhất cho từng room
                    fetchLatestMessage(null, room.id, function(latestMessage) {
                        latestMessages.push({
                            id: room.id,
                            name: room.name,
                            avatar: room.avatar,
                            type: 'room',
                            latestMessage: latestMessage
                        });
                        // Cập nhật giao diện sau khi có tất cả thông tin
                        updateChatListDisplay();
                    });
                });
                joinAllChannels(null, rooms);
            }
        },
        error: function (error) {
            console.error('Error fetching chat rooms:', error);
        }
    });
}
function fetchChatRoomMembers(roomId) {
    let html = '';
    let showDeleteButton = '';
    let usersInRoom = new Set();
    $.ajax({
        url: `/api/userchatrooms/chat-rooms/?room_id=${roomId}`,
        method: 'GET',
        success: function (response) {
            const users = response.users;
            const roomCreatorId = response.room_creator_id;

            if (users.length > 0) {
                $.each(users, function (index, user) {
                    usersInRoom.add(user.id);
                    if (roomCreatorId === Number(currentUserId)) {
                        document.getElementById("btnAddUser").style.display = "block";
                        if (user.id !== roomCreatorId) {
                            showDeleteButton = `
                                <form id="delete-form" method="POST" data-user-id="${user.id}" data-room-id="${roomId}" style="position: absolute; right: 15px; bottom: 20px;">
                                    <input type="hidden" name="csrfmiddlewaretoken" value="${getCookie('csrftoken')}">
                                    <button type="submit" class="delete-button" style="background: none; border: none;">
                                        <i class="fa-solid fa-user-minus"></i>
                                    </button>
                                </form>`;
                        }
                    }
                    const miniContent = (user.id === roomCreatorId) ? 'Trưởng nhóm' : user.email;

                    html += `
                    <div class="mess1" style="position: relative">
                        <a href="profile/${user.id}" style="color:black">
                            <div class="ava" style="padding:27px;background-image: url('${user.avatar}');background-position: center;"></div>
                            <div class="username">${user.username}</div>
                        </a><br><br>
                        <div class="mini_content">${miniContent}</div>
                         ${showDeleteButton}
                    </div>`;
                });
                $('.memberList').html(html);
            }

            fetchAllUsers(function (allUsers) {
                let userNotInRoomList = '';
                $.each(allUsers, function (index, item) {
                    if (!usersInRoom.has(item.id)) {
                        userNotInRoomList += `
                            <label for="mess${item.id}" class="mess1">
                                <div class="ava" style="background-image: url('${item.avatar}')"></div>
                                <div class="username">${item.username}</div><br><br>
                                <div class="mini_content">${item.email}</div>
                                <input type="checkbox" name="addUserId" value="${item.id}" id="mess${item.id}" style="float:right;margin:-20px 20px">
                            </label>`;
                    }
                });
                $('.showUsersNotInRoomId').html(userNotInRoomList);
            });
        },
        error: function (error) {
            console.error('Error fetching chat rooms:', error);
        }
    });
}


// Hàm lấy tin nhắn gần nhất và gọi callback với thông tin tin nhắn
function fetchLatestMessage(user_id, room_id, callback) {
    if (user_id === null && room_id === null) return;

    let url = `/api/messages/get-messages`;
    if (user_id) {
        url += `?user_id=${user_id}`;
    } else if (room_id) {
        url += `?room_id=${room_id}`;
    }

    $.ajax({
        url: url,
        method: 'GET',
        success: function(messages) {
            if (messages.length > 0) {
                let latestMessage = messages[messages.length - 1]; // Lấy tin nhắn gần nhất
                callback(latestMessage); // Gọi callback với thông tin tin nhắn gần nhất
            } else {
                callback(null); // Không có tin nhắn nào
            }
        },
        error: function(error) {
            console.error('Error fetching latest message:', error);
            callback(null); // Gọi callback với null khi có lỗi
        }
    });
}

// Cập nhật giao diện hiển thị danh sách chat
function updateChatListDisplay() {
    $('.chat_users_list').html('');
    // Sắp xếp mảng latestMessages theo thời gian gần nhất
    latestMessages.sort((a, b) => {
        const aDate = a.latestMessage ? new Date(a.latestMessage.created_at) : 0;
        const bDate = b.latestMessage ? new Date(b.latestMessage.created_at) : 0;
        return bDate - aDate; // Sắp xếp giảm dần
    });

    // Hiển thị lại danh sách người dùng và phòng chat
    $.each(latestMessages, function(index, item) {
        let html = '';
        let bold = '';
        if (item.latestMessage.message_by !== currentUserId) {
            bold = 'font-weight:bold; color:black';
        }

        if (item.type === 'user') {
            html = `
            <a onclick="openChat(${item.id}, null, ${item.latestMessage.id})">
                <div class="mess1" id="chat-user" style="position:relative" data-chat-user-id="${item.id}">
                    <div class="ava" style="background-image: url('${item.avatar}'); background-position: center"></div>
                    <div class="username">${item.username}</div>
                    <br><br>
                    <div class="mini_content" style="max-width:200px;">
                        <span class="latest_message" data-message-id="${item.latestMessage.id}" style="${bold}">${item.latestMessage.content}</span>
                        <div style="font-size:12px;position:absolute;right:20px;bottom:20px;" class="time_description">${calculateTimeAgo(item.latestMessage.created_at)}</div>
                    </div>
                </div>
            </a>`;
        } else if (item.type === 'room') {
            html = `
            <a onclick="openChat(null, ${item.id}, ${item.latestMessage.id})">
                <div class="mess1" id="chat-room" data-chat-room-id="${item.id}" style="position:relative">
                    <div class="ava" style="background-image: url('${item.avatar}');"></div>
                    <div class="username">${item.name}</div>
                    <br><br>
                    <div class="mini_content" style="max-width:200px;">
                        <span class="latest_message" data-message-id="${item.latestMessage.id}" style="${bold}">${item.latestMessage.content}</span>
                        <div style="font-size:12px;position:absolute;right:20px;bottom:20px;" class="time_description">${calculateTimeAgo(item.latestMessage.created_at)}</div>
                    </div>
                </div>
            </a>`;
        }
        $('.chat_users_list').append(html);
    });
}



// Hàm tính toán thời gian đã qua
function calculateTimeAgo(timestamp) {
    let timeAgo = new Date(timestamp);
    let now = new Date();
    let difference = Math.floor((now - timeAgo) / 1000);  // Tính sự chênh lệch theo giây

    if (difference < 60) {
        return `${difference} giây trước`;
    } else if (difference < 3600) {
        return `${Math.floor(difference / 60)} phút trước`;
    } else if (difference < 86400) {
        return `${Math.floor(difference / 3600)} giờ trước`;
    } else {
        return `${Math.floor(difference / 86400)} ngày trước`;
    }
}
document.addEventListener('DOMContentLoaded', function () {
    $('.showUsers').html('');
    fetchAllUsers();
    fetchChatUsers();
    fetchChatRooms();
    getQueryParams()
});
const userInfo = {};
function fetchInfo(recipientId = null, roomId = null, callback) {
    let apiUrl = '/api';

    if (roomId) {
        apiUrl += `/chatrooms/${roomId}`;
    } else if (recipientId) {
        apiUrl += `/users/${recipientId}`;
    }

    // Gọi API để lấy thông tin người dùng hoặc phòng chat
    $.ajax({
        url: apiUrl,
        type: 'GET',
        success: function (data) {
            if (recipientId) {
                userInfo[recipientId] = data;
            } else if (roomId) {
                userInfo[roomId] = data;
            }

            // Gọi callback nếu có
            if (callback) {
                callback();
            }
        },
        error: function (jqXHR, textStatus, errorThrown) {
            console.error('Lỗi khi lấy thông tin:', textStatus, errorThrown);
        }
    });
}
function getQueryParams() {
    const urlParams = new URLSearchParams(window.location.search);
    return {
        recipientId: urlParams.get('recipientId'),
        roomId: urlParams.get('roomId')
    };
}

// Get recipientId and roomId from the URL
const { recipientId, roomId } = getQueryParams();

let socketKey = null;
function openChat(recipientId, roomId, latestMessageId) {
    $('.content').html('');
    $('.memberList').html('');
    $('.showUsersNotInRoomId').html('');
    document.querySelector(".title_members").style.display = "none";
    document.getElementById("btnAddUser").style.display = "none";
    document.querySelector(".blocked_layout").style.display = "none";
    document.getElementById("messageForm").style.display = "block";

    socketKey = roomId ? `room_${roomId}` : `user_${Math.min(currentUserId, recipientId)}_${Math.max(currentUserId, recipientId)}`;

    // Hiển thị nút thêm người dùng nếu là phòng chat
    if (roomId) {
        document.querySelector(".title_members").style.display = "block";
        fetchChatRoomMembers(roomId)
    }
    $.ajax({
        url: `api/messages/${latestMessageId}/`,
        type: 'PATCH',
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        data: JSON.stringify({
            'read_status': true
        }),
        success: function (data) {
            const messageElement = document.querySelector(`.latest_message[data-message-id="${latestMessageId}"]`);
            if (messageElement) {
                messageElement.style = '';
            }
        },
        error: function(error) {
            console.error("Lỗi khi lưu tin nhắn:", error);
        }
    });
 setupMessageForm(recipientId, roomId, currentUserId);
// Gọi fetchInfo trước để lấy thông tin, sau đó cập nhật giao diện và tải tin nhắn
fetchInfo(recipientId, roomId, function() {
    let html1, html2, html = '';
    const data = userInfo[recipientId] || userInfo[roomId];
    if (data) {
        if (recipientId) {
            html1 = `
            <a href="profile/${data.id}" style="color:black">
                <div class="ava" style="padding:27px;background-image: url('${data.avatar}');background-position: center;"></div>
                <div class="username">${data.username}</div>
            </a><br><br>
            <div class="mini_content">Đang hoạt động</div>`;

            html = `
            <a href="profile/${data.id}" style="color:black">
                <div class="mess1">
                    <div class="ava" style="background-image: url('${data.avatar}');"></div>
                    <div class="username">${data.username}</div><br><br>
                    <div class="mini_content">${data.email}</div>
                </div>
            </a>`;

            html2 = `
            <a class="info_2" style="text-decoration:none;float:left" data-toggle="modal" href='#modalBlock'>Chặn người dùng này</a>
            <div class="modal fade" id="modalBlock">
                <div class="modal-dialog">
                    <div class="modal-content" style="border-radius:20px;margin:32vh auto;width:50vh">
                        <div class="modal-header">
                            <h5 class="modal-title" style="padding:5px 0 5px 30px">Chắc chắn muốn chặn?</h5>
                        </div>
                        <div class="modal-body" style="padding:0">
                            <form method="post" id="blockForm">
                                <input type="hidden" name="csrfmiddlewaretoken" value="${getCookie('csrftoken')}">
                                <button type="submit" data-user-id="${data.id}" class="info_2" style="text-align:center;border:none;background:none;border-bottom:1px solid #EEE;padding:15px 20px">Chặn</button>
                            </form>
                            <div class="info_2" data-dismiss="modal" style="text-align:center;color:black;padding:20px">Hủy</div>
                        </div>
                    </div>
                </div>
            </div>
           <!-- Modal Xóa Cuộc Trò Chuyện -->
            <a class="info_2" style="text-decoration:none;float:left" data-toggle="modal" href='#modalDeleteChat'>Xóa cuộc trò chuyện</a>
            <div class="modal fade" id="modalDeleteChat">
                <div class="modal-dialog">
                    <div class="modal-content" style="border-radius:20px;margin:32vh auto;width:50vh">
                        <div class="modal-header">
                            <h5 class="modal-title" style="padding:5px 0 5px 30px">Xóa cuộc trò chuyện vĩnh viễn?</h5>
                        </div>
                        <div class="modal-body" style="padding:0">
                            <form method="post" id="deleteChatForm">
                                <input type="hidden" name="csrfmiddlewaretoken" value="${getCookie('csrftoken')}">
                                <button type="button" id="deleteChatButton" data-recipient-id="${data.id}" class="info_2" style="text-align:center;border:none;background:none;border-bottom:1px solid #EEE;padding:15px 20px">Xóa</button>
                            </form>
                            <div class="info_2" data-dismiss="modal" style="text-align:center;color:black;padding:20px">Hủy</div>
                        </div>
                    </div>
                </div>
            </div>
            `;
        } else {
            html1 = `
            <a data-toggle="modal" href='#modalUpdateAvatar1' style="color:black">
                <div class="ava" style="padding:27px;background-image: url('${data.avatar}');background-position: center;"></div>
                <div class="username">${data.name}</div>
            </a><br><br>
            <div class="modal fade" id="modalUpdateAvatar1">
              <div class="modal-dialog">
                <div class="modal-content" style="width:380px; border-radius:15px;margin:16vh auto">
                  <div class="modal-header" style="border-bottom: 1px solid #DBDBDB;height:50px">
                    <h5 class="modal-title" style="position:absolute;left:31%;text-align:center;color:black">Thông tin nhóm</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true" style="border:none;padding:30px;background:none;position:absolute;right:0">&times;</button>
                  </div>
                <form action="" method="post" enctype="multipart/form-data" id="updateRoomForm">
                  <div class="modal-body" style="padding:10px;overflow:auto">
                        <div class="previewAvatar ava" style="width: 85px; height:85px;position: relative;left:40%;background-image: url('${data.avatar}')">
                            <input type="hidden" name="csrfmiddlewaretoken" value="${getCookie('csrftoken')}">
                            <input type="hidden" name="room_id" value="${data.room_id}">
                            <label for="avatarPicker" style="cursor: pointer;right:0;bottom:0;position:absolute;z-index:2;color:black">
                                <i class="fa-solid fa-camera"></i>
                            </label>
                            <input type="file" id="avatarPicker" accept="image/*" name="anhdaidien" style="display:none;" />
                        </div>
                        <div style="float:left;width:100%; margin-top: 15px">
                            <div style="float:left">Tên nhóm: </div>
                            <input name="name" style="float:left" value="${data.name}">
                        </div>
                  </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Lưu</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                    </div>
                </form>
                </div>
              </div>
            </div>`;

            html = `
            <a data-toggle="modal" href='#modalUpdateAvatar' style="color:black">
            <div class="mess1">
                <div class="ava" style="background-image: url('${data.avatar}');"></div></a>
                <div class="username">${data.name}</div><br><br>
            </div>
          <div class="modal fade" id="modalUpdateAvatar">
          <div class="modal-dialog">
            <div class="modal-content" style="width:380px; border-radius:15px;margin:16vh auto">
              <div class="modal-header" style="border-bottom: 1px solid #DBDBDB;height:50px">
                <h5 class="modal-title" style="position:absolute;left:31%;text-align:center;color:black">Thông tin nhóm</h5>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true" style="border:none;padding:30px;background:none;position:absolute;right:0">&times;</button>
              </div>
            <form action="" method="post" enctype="multipart/form-data" id="updateRoomForm">
              <div class="modal-body" style="padding:10px;overflow:auto">
                    <div class="previewAvatar ava" style="width: 85px; height:85px;position: relative;left:40%;background-image: url('${data.avatar}')">
                        <input type="hidden" name="csrfmiddlewaretoken" value="${getCookie('csrftoken')}">
                        <input type="hidden" name="room_id" value="${data.room_id}">
                        <label for="avatarPicker" style="cursor: pointer;right:0;bottom:0;position:absolute;z-index:2;color:black">
                            <i class="fa-solid fa-camera"></i>
                        </label>
                        <input type="file" id="avatarPicker" accept="image/*" name="anhdaidien" style="display:none;" />
                    </div>
                    <div style="float:left;width:100%; margin-top: 15px">
                        <div style="float:left">Tên nhóm: </div>
                        <input name="name" style="float:left" value="${data.name}">
                    </div>
              </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Lưu</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                </div>
            </form>
            </div>
          </div>
        </div>`;

            html2 = `
                <a class="info_2" style="text-decoration:none;float:left" data-toggle="modal" href='#modalLeave'>Rời nhóm</a>
                <div class="modal fade" id="modalLeave">
                    <div class="modal-dialog">
                        <div class="modal-content" style="border-radius:20px;margin:32vh auto;width:50vh">
                            <div class="modal-header">
                                <h5 class="modal-title" style="padding:5px 0 5px 30px">Chắc chắn muốn rời?</h5>
                            </div>
                            <div class="modal-body" style="padding:0">
                                <form id="leaveRoomForm" method="post">
                                    <input type="hidden" name="csrfmiddlewaretoken" value="${getCookie('csrftoken')}">
                                    <button type="submit" class="info_2" style="text-align:center;border:none;background:none;border-bottom:1px solid #EEE;padding:15px 20px">Rời nhóm</button>
                                </form>
                                <div class="info_2" data-dismiss="modal" style="text-align:center;color:black;padding:20px">Hủy</div>
                            </div>
                        </div>
                    </div>
                </div>
              <!-- Modal Xóa Nhóm Trò Chuyện -->
            <a class="info_2" style="text-decoration:none;float:left" data-toggle="modal" href='#modalDeleteChatroom'>Xóa nhóm trò chuyện</a>
            <div class="modal fade" id="modalDeleteChatroom">
                <div class="modal-dialog">
                    <div class="modal-content" style="border-radius:20px;margin:32vh auto;width:50vh">
                        <div class="modal-header">
                            <h5 class="modal-title" style="padding:5px 0 5px 30px">Xóa nhóm trò chuyện vĩnh viễn?</h5>
                        </div>
                        <div class="modal-body" style="padding:0">
                            <form method="post" id="deleteChatroomForm">
                                <input type="hidden" name="csrfmiddlewaretoken" value="${getCookie('csrftoken')}">
                                <button type="submit" data-room-id="${data.room_id}" class="info_2" style="text-align:center;border:none;background:none;border-bottom:1px solid #EEE;padding:15px 20px">Xóa</button>
                            </form>
                            <div class="info_2" data-dismiss="modal" style="text-align:center;color:black;padding:20px">Hủy</div>
                        </div>
                    </div>
                </div>
            </div>
            `;
            }
            $('#userInfo').html(html1);
            $('.layout_info1').html(html);
            $('.layout_info2').html(html2);
        }
    // Kiểm tra trạng thái chặn
        checkBlockStatus(recipientId, currentUserId);
        // Sau khi lấy thông tin xong, tải tin nhắn
        loadMessage(roomId, recipientId, currentUserId);
    });
}

function checkBlockStatus(recipientId) {
    $.ajax({
        url: `/api/blockedusers/check-blocked-status/?recipient_id=${recipientId}`,
        type: "GET",
        success: function (response) {
            if (response.status === "blocked_by_recipient") {
                document.querySelector(".blocked_layout").style.display = "block";
                document.getElementById("messageForm").style.display = "none";
            }
        },
        error: function (xhr) {
            console.error("Error checking block status:", xhr.responseText);
        }
    });
}

// Check if the parameters exist, then call openChat
if (recipientId) {
    openChat(recipientId, roomId);
    window.history.replaceState({}, '', window.location.origin);
}
document.addEventListener('change', function (event) {
    if (event.target && event.target.id === 'avatarPicker') {
        const preview = document.querySelector('.previewAvatar');
        const file = event.target.files[0]; // Lấy file được chọn

        if (file) {
            const objectURL = URL.createObjectURL(file); // Tạo URL tạm thời cho file
            preview.style.backgroundImage = `url("${objectURL}")`;
            preview.style.display = 'block';
        } else {
            preview.style.display = 'none'; // Ẩn ảnh nếu không có file
        }
    }
});


let joinedChannels = new Set();
function joinAllChannels(users, rooms) {
    const identifiers = [];

    // Thêm tất cả các user identifiers vào mảng
    $.each(users, function (index, user) {
        const userChannel = `user_${Math.min(currentUserId, user.id)}_${Math.max(currentUserId, user.id)}`;
        // Kiểm tra nếu kênh chưa được tham gia
        if (!joinedChannels.has(userChannel)) {
            identifiers.push(userChannel);
            joinedChannels.add(userChannel);  // Đánh dấu là đã tham gia
        }
    });

    // Thêm tất cả các room identifiers vào mảng
    $.each(rooms, function (index, room) {
        const roomChannel = `room_${room.id}`;
        // Kiểm tra nếu kênh chưa được tham gia
        if (!joinedChannels.has(roomChannel)) {
            identifiers.push(roomChannel);
            joinedChannels.add(roomChannel);  // Đánh dấu là đã tham gia
        }
    });

    // Sau khi đã có danh sách các identifier, tham gia tất cả các kênh
    setupWebSocket(identifiers, currentUserId);
}

let sockets = {};
function setupWebSocket(identifiers, currentUserId) {
    // Tạo kết nối WebSocket cho mỗi kênh
    identifiers.forEach(identifier => {
        const ws_url = `wss://${window.location.host}/ws/app/${identifier}/`;
        const socket = new WebSocket(ws_url);

        socket.onopen = function () {
            console.log(`WebSocket kết nối thành công với kênh ${identifier}`);
        };

        socket.onmessage = function (event) {
            const data = JSON.parse(event.data);
            console.log(`Message received on ${identifier}:`, data);

            if (socketKey === identifier) {
                // Nếu đúng kênh, hiển thị tin nhắn
                displayMessage(data, currentUserId);
                latestMessages = [];
                fetchChatRooms();
                fetchChatUsers();
            }
        };


        socket.onclose = function () {
            console.error(`WebSocket kết nối với ${identifier} bị đóng. Đang thử kết nối lại...`);
            setTimeout(function () {
                location.reload();
            }, 500000);
        };
        sockets[identifier] = socket;
    });
}

function setupMessageForm(recipientId, roomId, currentUserId) {
    $('#image').off('change').on('change', function (event) {
        const file = event.target.files[0];  // Lấy tệp tin được chọn (ảnh hoặc video)

        if (file) {
            // Dữ liệu gửi qua API
            const formData = new FormData();
            formData.append('content', 'Đã gửi một tệp.');
            formData.append('message_by', currentUserId);
            formData.append('message_type', file.type.startsWith('image') ? 'image' : 'video');
            formData.append('file', file);

            if (roomId) {
                formData.append('room_id', roomId);
            } else if (recipientId) {
                formData.append('message_to', recipientId);
            }

            // Gửi tin nhắn qua AJAX
            $.ajax({
                url: 'api/messages/send_message/',  // URL gửi tin nhắn
                type: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                data: formData,
                processData: false,  // Không tự động chuyển đổi dữ liệu
                contentType: false,  // Cho phép gửi dữ liệu không có content-type
                success: function (data) {
                    console.log('Tin nhắn đã được thêm vào cơ sở dữ liệu:', data);
                    // Gửi tin nhắn qua WebSocket
                    fetchInfo(currentUserId, null, function () {
                        const userData = userInfo[currentUserId];

                        if (sockets[socketKey]) {
                            sockets[socketKey].send(JSON.stringify({
                                'content': `${userData.username} đã gửi một tệp.`,
                                'message_by': data.message_by,
                                'message_to': data.message_to,
                                'room_id': data.room_id,
                                'message_type': data.message_type,
                                'file': data.file,
                                'avatar':userData.avatar,
                                'username': userData.username
                            }));
                        }
                    });
                },
                error: function (error) {
                    console.error("Lỗi khi lưu tin nhắn:", error);
                }
            });
            $('#image').val('');  // Xóa tệp tin đã chọn
        }
    });


    $('#messageForm').off('submit').on('submit', function (event) {
        event.preventDefault();
        const content = $('textarea[name="content"]').val();
        if (content.trim() !== "") {
            // Dữ liệu gửi qua API
            const payload = {
                'content': content,
                'message_by': currentUserId,
                'message_type': 'text'
            };

            if (roomId) {
                payload['room_id'] = roomId;
                payload['message_to'] = null;
            } else if (recipientId) {
                payload['room_id'] = null;
                payload['message_to'] = recipientId;
            }
            // Gửi tin nhắn qua WebSocket
            fetchInfo(currentUserId, null, function () {
                const userData = userInfo[currentUserId];

                if (sockets[socketKey]) {
                    sockets[socketKey].send(JSON.stringify({
                        'content': content,
                        'message_by': currentUserId,
                        'message_to': recipientId,
                        'room_id': roomId,
                        'message_type': 'text',
                        'avatar': userData.avatar,
                        'username': userData.username
                    }));
                }
            });
            // Gửi tin nhắn đến API
            $.ajax({
                url: 'api/messages/send_message/',
                type: 'POST',
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                data: JSON.stringify(payload),
                success: function (data) {
                    console.log('Tin nhắn đã được thêm vào cơ sở dữ liệu:', data);
                },
                error: function(error) {
                    console.error("Lỗi khi lưu tin nhắn:", error);
                }
            });

            // Xóa nội dung sau khi gửi
            $('textarea[name="content"]').val('');
        }
    });


    $('#addMembersForm').off('submit').on('submit', function (e) {
        e.preventDefault();

        const selectedUserIds = $('input[name="addUserId"]:checked').map(function() {
            return $(this).val();
        }).get();

        if (selectedUserIds.length === 0) {
            alert('Vui lòng chọn ít nhất một người dùng.');
            return;
        }

        $.ajax({
            url: '/api/userchatrooms/add-users/',
            type: 'POST',
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')  // Cần nếu dùng Django CSRF
            },
            data: JSON.stringify({
                room_id: roomId,
                user_ids: selectedUserIds
            }),
            success: function (response) {
                alert(response.message);
                fetchChatRoomMembers(roomId)
            },
            error: function (error) {
                console.error("Lỗi khi thêm người dùng vào phòng:", error);
            }
        });
    });
    $(document).off('submit', '#delete-form').on('submit', '#delete-form', function (e) {
        e.preventDefault();

        const form = $(this);
        const userIdToDelete = form.data('user-id');
        const roomId = form.data('room-id');

        $.ajax({
            url: '/api/userchatrooms/delete-user-from-room/',
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            data: {
                user_id: userIdToDelete,
                room_id: roomId
            },
            success: function(response) {
                fetchChatRoomMembers(roomId);
            },
            error: function(xhr, status, error) {
                console.error('Error occurred:', error);
            }
        });
    });
    $(document).off('submit', '#leaveRoomForm').on('submit', '#leaveRoomForm', function (e) {
        e.preventDefault();

        $.ajax({
            url: '/api/userchatrooms/delete-user-from-room/',
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            data: {
                user_id: currentUserId,
                room_id: roomId
            },
            success: function(response) {
                window.location.reload();
            },
            error: function(xhr, status, error) {
                console.error('Error occurred:', error);
            }
        });
    });

    $(document).off('submit', '#blockForm').on('submit', '#blockForm', function (e) {
        e.preventDefault();

        $.ajax({
            url: '/api/blockedusers/block/',
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            data: {
                blocker_id: currentUserId,
                blocked_id: recipientId
            },
            success: function(response) {
                window.location.reload();
            },
            error: function(xhr) {
                console.error('Lỗi khi chặn người dùng:', xhr.responseText);
            }
        });
    });


    $(document).off('submit', '#updateRoomForm').on('submit', '#updateRoomForm', function (e) {
        const input = document.getElementById('avatarPicker');
        const nameInput = document.querySelector('input[name="name"]'); // Lấy input tên nhóm
        const formData = new FormData();

        // Thêm room_id và name vào formData
        formData.append('room_id', roomId);
        formData.append('name', nameInput.value);

        // Kiểm tra nếu có file ảnh thì thêm vào formData
        if (input && input.files && input.files.length > 0) {
            formData.append('avatar', input.files[0]);
        }

        // Gửi request
        $.ajax({
            url: `/api/chatrooms/update-room/`,
            type: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                alert(response.message);
                window.location.reload();
            },
            error: function(xhr) {
                console.error('Error:', xhr.responseText);
            }
        });
    });
}

// Lấy các tin nhắn cũ qua API
async function loadMessage(roomId = null, recipientId = null, currentUserId) {
    let apiUrl = '/api/messages/get-messages';

    if (roomId) {
        apiUrl += `?room_id=${roomId}`;
    } else if (recipientId) {
        apiUrl += `?user_id=${recipientId}`;
    }

    try {
        const response = await $.ajax({
            url: apiUrl,
            type: 'GET',
        });
        const recentMessages = response.slice(-50);
        for (const message of recentMessages) {
            const messageById = Number(message.message_by);
            const currentUserIdNumber = Number(currentUserId);

            if (messageById !== currentUserIdNumber) {
                await new Promise((resolve) => {
                    fetchInfo(message.message_by, null, () => {
                        const user = userInfo[message.message_by];
                        if (user) {
                            message.avatar = user.avatar;
                            message.username = user.username;
                        }
                        displayMessage(message, currentUserId);
                        resolve();
                    });
                });
            } else {
                displayMessage(message, currentUserId);
            }
        }
    } catch (error) {
        console.error('Lỗi khi tải tin nhắn cũ:', error);
    }
}


function displayMessage(data, currentUserId) {
    let messageHtml;
    let messageClass;
    const messageById = Number(data.message_by);
    const currentUserIdNumber = Number(currentUserId);

    if (messageById === currentUserIdNumber) {
        messageClass = 'sent-message';
    } else {
        messageClass = 'received-message';
    }
    switch (data.message_type) {
        case 'text':
            // Chỉ hiển thị avatar nếu không phải là tin nhắn của currentUserId
            if (messageById !== currentUserIdNumber) {
                messageHtml = '<div class="content-message">' +
                    '<div class="ava" style="width: 25px;height:25px;margin-top: 25px;padding:0;background-image: url('+ data.avatar + '); background-position: center"></div>' +
                    '<div class="mini_content" style="position: absolute;left: 45px;top: -10px;">' + data.username + '</div>' +
                    '<div class="text-message ' + messageClass + '">' + data.content + '</div></div>';
            }else{
                messageHtml = '<div class="content-message"><div class="text-message ' + messageClass + '">' + data.content + '</div></div>';
            }
        break;
        case 'image':
            if (messageById !== currentUserIdNumber) {
                messageHtml = '<div class="content-message">' +
                    '<div class="ava" style="width: 25px;height:25px;margin-top: 25px;position:absolute; bottom:0;padding:0;background-image: url('+ data.avatar + '); background-position: center"></div>' +
                    '<div class="mini_content" style="position: absolute;left: 45px;top: -10px;">' + data.username + '</div>' +
                    '<img class="image-message ' + messageClass + '" src="' + data.file + '" alt="Image" /></div>';
            }else{
                messageHtml = '<div class="content-message"><img class="image-message ' + messageClass + '" src="' + data.file + '" alt="Image" /></div>';
            }

            break;
        case 'video':
            if (messageById !== currentUserIdNumber) {
                messageHtml = '<div class="content-message">' +
                    '<div class="ava" style="width: 25px;height:25px;margin-top: 25px;position:absolute; bottom:0;padding:0;background-image: url('+ data.avatar + '); background-position: center"></div>' +
                    '<div class="mini_content" style="position: absolute;left: 45px;top: -10px;">' + data.username + '</div>' +
                    '<video class=" image-message ' + messageClass + '" controls><source src="' + data.file + '">Trình duyệt của bạn không hỗ trợ video.</video></div>';
            }else{
                messageHtml = '<div class="content-message"><div class=" image-message ' + messageClass + '"><video class=" image-message ' + messageClass + '" controls><source src="' + data.file + '">Trình duyệt của bạn không hỗ trợ video.</video></div></div>';
            }
            break;
        case 'link':
            messageHtml = '<div class="content-message"><div class=" link-message ' + messageClass + '"><a href="' + data.content + '" target="_blank">' + data.content + '</a></div></div>';
            break;
        default:
            messageHtml = '<div class="content-message"><div class="unknown-message"></div></div>';
    }

    $('.content').append(messageHtml);
    $('.content').scrollTop($('.content')[0].scrollHeight);
}

// Hàm lấy CSRF token từ cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Cấu hình jQuery để gửi CSRF token trong header của yêu cầu AJAX
const csrfToken = getCookie('csrftoken');
$.ajaxSetup({
    headers: {
        'X-CSRFToken': csrfToken
    }
});



function performLiveSearch(query) {
    console.log("Searching for:", query);

    // Kiểm tra nếu không có từ khóa tìm kiếm (từ khóa rỗng)
    if (query.length === 0) {
        // Khi không có từ khóa tìm kiếm, hiển thị lại danh sách ban đầu và ẩn kết quả tìm kiếm
        $('#chatUsersListContainer').fadeOut(); // Ẩn kết quả tìm kiếm
        $('.chat_users_list').fadeIn(); // Hiển thị danh sách ban đầu (dùng class chat_users_list)
        return;
    }

    // Ẩn danh sách người dùng ban đầu và hiển thị kết quả tìm kiếm
    $('.chat_users_list').fadeOut(); // Ẩn danh sách ban đầu
    $('#chatUsersListContainer').fadeIn(); // Hiển thị kết quả tìm kiếm

    $.ajax({
        url: '/api/search-chats/?query=' + query, // API tìm kiếm
        method: 'GET',
        success: function (data) {
            $('#chatUsersListContainer').html(''); // Xóa danh sách trước đó

            if (data.length > 0) {
                // Nếu có kết quả tìm kiếm
                $.each(data, function (index, item) {
                    let html = '';
                    if (item.type === 'user') {
                        html = `
                            <a onclick="openChat(${item.id}, null)">
                                <div class="mess1" id="chat-user" style="position:relative" data-chat-user-id="${item.id}">
                                    <div class="ava" style="background-image: url('${item.avatar || '/default-avatar.png'}'); background-position: center"></div>
                                    <div class="username">${item.username}</div>
                                </div>
                            </a>`;
                    } else if (item.type === 'room') {
                        html = `
                            <a onclick="openChat(null, ${item.id})">
                                <div class="mess1" id="chat-room" style="position:relative" data-chat-room-id="${item.id}">
                                    <div class="ava" style="background-image: url('${item.avatar || '/default-room-avatar.png'}');"></div>
                                    <div class="username">${item.name}</div>
                                </div>
                            </a>`;
                    }

                    $('#chatUsersListContainer').append(html); // Thêm kết quả vào container
                });
            } else {
                $('#chatUsersListContainer').html('<p>Không tìm thấy kết quả phù hợp.</p>'); // Không có kết quả
            }
        },
        error: function (error) {
            console.error('Error searching chats:', error);
            $('#chatUsersListContainer').html('<p>Đã xảy ra lỗi khi tìm kiếm.</p>'); // Hiển thị lỗi
        }
    });
}


// Sự kiện khi nhấn nút Xóa Tin nhắn
$(document).on('click', '#deleteChatButton', function(event) {
    event.preventDefault(); // Ngừng hành động mặc định của nút

    var recipientId = $(this).data('recipient-id');  // Lấy recipientId từ thuộc tính data
    var currentUserId = "{{ request.session.current_user_id }}"; // Lấy current_user_id từ session

    console.log('Đang gửi yêu cầu xóa cho recipientId:', recipientId); // Kiểm tra recipientId
    console.log('ID người dùng hiện tại:', currentUserId); // In ID người dùng hiện tại

    // Gọi Ajax để thực hiện yêu cầu xóa tin nhắn
    $.ajax({
        url: '/api/messages/delete-all-messages/',  // URL để gọi action custom
        type: 'POST',  // Phương thức POST
        data: {
            user_id: recipientId,  // ID người nhận
            current_user_id: currentUserId,  // ID người dùng hiện tại
            csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val() // CSRF token nếu cần
        },
        success: function(response) {
            console.log('Xóa cuộc trò chuyện thành công!', response);
            // Đóng modal sau khi xóa
            $('#modalDeleteChat').modal('hide');
            // Tải lại trang sau khi xóa
            location.reload();  // Tải lại trang
        },
        error: function(error) {
            console.error('Lỗi khi xóa cuộc trò chuyện:', error);
        }
    });
});

// Sự kiện khi nhấn Xóa tất cả tin nhắn trong phòng
$(document).on('submit', '#deleteRoomChatForm', function(e) {
    e.preventDefault();

    var roomId = $(this).find('button').data('room-id');  // Lấy room_id từ thuộc tính data của nút
    var currentUserId = "{{ request.session.current_user_id }}"; // Lấy current_user_id từ session

    console.log('Đang gửi yêu cầu xóa tất cả tin nhắn trong phòng:', roomId); // Kiểm tra roomId
    console.log('ID người dùng hiện tại:', currentUserId); // In ID người dùng hiện tại

    // Gọi Ajax để thực hiện yêu cầu xóa tin nhắn trong phòng chat
    $.ajax({
        url: '/api/messages/delete-all-messages/',  // URL để gọi action custom
        type: 'POST',
        data: {
            room_id: roomId,  // ID phòng chat
            current_user_id: currentUserId,  // ID người dùng hiện tại
            csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val()  // CSRF token nếu cần
        },
        success: function(response) {
            console.log('Xóa tin nhắn trong phòng thành công!', response);
            // Đóng modal sau khi xóa
            $('#modalDeleteRoomChat').modal('hide');
            // Tải lại trang sau khi xóa
            location.reload();  // Tải lại trang
        },
        error: function(error) {
            console.error('Lỗi khi xóa tin nhắn trong phòng:', error);
        }
    });
});


</script>
